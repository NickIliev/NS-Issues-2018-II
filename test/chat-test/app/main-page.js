"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var nativescript_chatview_1 = require("nativescript-chatview");
var Timer = require("tns-core-modules/timer");
var TypeUtils = require("tns-core-modules/utils/types");
var observable_1 = require("tns-core-modules/data/observable");
function createAnswer(msg) {
    if (/(\s*)([0-9]+)(\.?)([0-9]*)(\s*)([\+|\-|\*|\/])(\s*)([0-9]+)(\.?)([0-9]*)/i.test(msg)) {
        var result;
        eval("result = " + msg + ";");
        return result;
    }
    else if (checkForAllTerms(getLettersAndDigitsOnly(msg), "how", "are", "you")) {
        return "Fine!";
    }
    else if (checkForAllTerms(getLettersAndDigitsOnly(msg), "what", "time", "is", "it")) {
        return getTime();
    }
    else if (checkForAllTerms(getLettersAndDigitsOnly(msg), "hi")) {
        return "Hi! How are you?";
    }
    else if (checkForAllTerms(getLettersAndDigitsOnly(msg), "fine")) {
        return "Cool!";
    }
    return 'You said: "' + msg + '"';
}
function getSimilarity(left, right) {
    if (left === right) {
        return 1;
    }
    if (TypeUtils.isNullOrUndefined(left) ||
        TypeUtils.isNullOrUndefined(right)) {
        return 0;
    }
    left = left.toLowerCase().trim();
    right = right.toLowerCase().trim();
    var distance = 0;
    if (left !== right) {
        var matrix = new Array(left.length + 1);
        for (var i = 0; i < matrix.length; i++) {
            matrix[i] = new Array(right.length + 1);
            for (var ii = 0; ii < matrix[i].length; ii++) {
                matrix[i][ii] = 0;
            }
        }
        for (var i = 0; i <= left.length; i++) {
            matrix[i][0] = i;
        }
        for (var j = 0; j <= right.length; j++) {
            matrix[0][j] = j;
        }
        for (var i = 0; i < left.length; i++) {
            for (var j = 0; j < right.length; j++) {
                if (left[i] === right[j]) {
                    matrix[i + 1][j + 1] = matrix[i][j];
                }
                else {
                    matrix[i + 1][j + 1] = Math.min(matrix[i][j + 1] + 1, matrix[i + 1][j] + 1);
                    matrix[i + 1][j + 1] = Math.min(matrix[i + 1][j + 1], matrix[i][j] + 1);
                }
            }
            distance = matrix[left.length][right.length];
        }
    }
    return 1.0 - distance / Math.max(left.length, right.length);
}
function checkForAllTerms(str) {
    var terms = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        terms[_i - 1] = arguments[_i];
    }
    var parts = str.split(" ");
    for (var i = 0; i < parts.length; i++) {
        var p = parts[i];
        if (p.trim() === "") {
            continue;
        }
        var found = false;
        for (var ii = 0; ii < terms.length; ii++) {
            var t = terms[ii];
            if (getSimilarity(p, t) >= 0.5) {
                found = true;
                break;
            }
        }
        if (!found) {
            return false;
        }
    }
    return true;
}
function getLettersAndDigitsOnly(str) {
    var result = "";
    for (var i = 0; i < str.length; i++) {
        if (/[a-zA-Z0-9]/i.test(str[i])) {
            result += str[i];
        }
        else if (/[\s]/i.test(str[i])) {
            result += " ";
        }
    }
    return result;
}
function getTime() {
    var now = new Date();
    var hours = now.getHours();
    return numberToString(hours == 12 ? 12 : (hours % 12)) + ":" + numberToString(now.getMinutes()) + " " +
        (hours < 13 ? "AM" : "PM");
}
function numberToString(n) {
    var str = "" + n;
    if (n < 10) {
        str = "0" + str;
    }
    return str;
}
function onLoaded(args) {
    var page = args.object;
    page.bindingContext = observable_1.fromObject({});
    var chatView = new nativescript_chatview_1.ChatView();
    chatView.sendMessageButtonCaption = "Send";
    chatView.typeMessageHint = "Your message for Albert";
    chatView.notifyOnSendMessageTap(function (eventData) {
        eventData.object.appendMessages({
            date: getTime(),
            isRight: true,
            image: "~/img/marcel.jpg",
            message: eventData.message,
        });
        eventData.resetMessage();
        eventData.scrollToBottom();
        eventData.focusTextField();
        Timer.setTimeout(function () {
            eventData.object.appendMessages({
                date: getTime(),
                isRight: false,
                image: "~/img/alert.jpg",
                message: createAnswer(eventData.message),
            });
        }, Math.floor(Math.random() * 2000));
    });
    chatView.focusMessageField();
    page.content = chatView;
}
exports.onLoaded = onLoaded;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0RBQWlEO0FBRWpELDhDQUFnRDtBQUNoRCx3REFBMEQ7QUFDMUQsK0RBQXlFO0FBRXpFLFNBQVMsWUFBWSxDQUFDLEdBQUc7SUFDckIsSUFBSSwyRUFBMkUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDdkYsSUFBSSxNQUFNLENBQUM7UUFDWCxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUU5QixPQUFPLE1BQU0sQ0FBQztLQUNqQjtTQUNJLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsRUFBRTtRQUMxRSxPQUFPLE9BQU8sQ0FBQztLQUNsQjtTQUNJLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUU7UUFDakYsT0FBTyxPQUFPLEVBQUUsQ0FBQztLQUNwQjtTQUNJLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUU7UUFDM0QsT0FBTyxrQkFBa0IsQ0FBQztLQUM3QjtTQUNJLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxDQUFDLEVBQUU7UUFDN0QsT0FBTyxPQUFPLENBQUM7S0FDbEI7SUFFRCxPQUFPLGFBQWEsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO0FBQ3JDLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxJQUFZLEVBQUUsS0FBYTtJQUM5QyxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7UUFDaEIsT0FBTyxDQUFDLENBQUM7S0FDWjtJQUVELElBQUks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Q0FBQyxDQUFDO0lBRXJDLElBQUksUUFBUSxHQUFHLElBQUksZ0NBQVEsRUFBRSxDQUFDO0lBQzlCLFFBQVEsQ0FBQyx3QkFBd0IsR0FBRyxNQUFNLENBQUM7SUFDM0MsUUFBUSxDQUFDLGVBQWUsR0FBRyx5QkFBeUIsQ0FBQztJQUVyRCxRQUFRLENBQUMsc0JBQXNCLENBQUMsVUFBQyxTQUFTO1FBQ3RDLFNBQVMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO1lBQzVCLElBQUksRUFBRSxPQUFPLEVBQUU7WUFDZixPQUFPLEVBQUUsSUFBSTtZQUNiLEtBQUssRUFBRSxrQkFBa0I7WUFDekIsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPO1NBQzdCLENBQUMsQ0FBQztRQUVILFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN6QixTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDM0IsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRTNCLEtBQUssQ0FBQyxVQUFVLENBQUM7WUFDZCxTQUFTLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQztnQkFDNUIsSUFBSSxFQUFFLE9BQU8sRUFBRTtnQkFDZixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsaUJBQWlCO2dCQUN4QixPQUFPLEVBQUUsWUFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7YUFDM0MsQ0FBQyxDQUFDO1FBQ04sQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUU3QixJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQztBQUM1QixDQUFDO0FBakNELDRCQWlDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYXRWaWV3IH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1jaGF0dmlld1wiO1xuaW1wb3J0IHsgUGFnZSB9ZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvcGFnZVwiO1xuaW1wb3J0ICogYXMgVGltZXIgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdGltZXJcIjtcbmltcG9ydCAqIGFzIFR5cGVVdGlscyBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91dGlscy90eXBlc1wiO1xuaW1wb3J0IHsgZnJvbU9iamVjdCwgRXZlbnREYXRhIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvZGF0YS9vYnNlcnZhYmxlXCI7XG5cbmZ1bmN0aW9uIGNyZWF0ZUFuc3dlcihtc2cpIDogc3RyaW5nIHtcbiAgICBpZiAoLyhcXHMqKShbMC05XSspKFxcLj8pKFswLTldKikoXFxzKikoW1xcK3xcXC18XFwqfFxcL10pKFxccyopKFswLTldKykoXFwuPykoWzAtOV0qKS9pLnRlc3QobXNnKSkge1xuICAgICAgICB2YXIgcmVzdWx0O1xuICAgICAgICBldmFsKFwicmVzdWx0ID0gXCIgKyBtc2cgKyBcIjtcIik7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBlbHNlIGlmIChjaGVja0ZvckFsbFRlcm1zKGdldExldHRlcnNBbmREaWdpdHNPbmx5KG1zZyksIFwiaG93XCIsIFwiYXJlXCIsIFwieW91XCIpKSB7XG4gICAgICAgIHJldHVybiBcIkZpbmUhXCI7XG4gICAgfVxuICAgIGVsc2UgaWYgKGNoZWNrRm9yQWxsVGVybXMoZ2V0TGV0dGVyc0FuZERpZ2l0c09ubHkobXNnKSwgXCJ3aGF0XCIsIFwidGltZVwiLCBcImlzXCIsIFwiaXRcIikpIHtcbiAgICAgICAgcmV0dXJuIGdldFRpbWUoKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoY2hlY2tGb3JBbGxUZXJtcyhnZXRMZXR0ZXJzQW5kRGlnaXRzT25seShtc2cpLCBcImhpXCIpKSB7XG4gICAgICAgIHJldHVybiBcIkhpISBIb3cgYXJlIHlvdT9cIjtcbiAgICB9XG4gICAgZWxzZSBpZiAoY2hlY2tGb3JBbGxUZXJtcyhnZXRMZXR0ZXJzQW5kRGlnaXRzT25seShtc2cpLCBcImZpbmVcIikpIHtcbiAgICAgICAgcmV0dXJuIFwiQ29vbCFcIjtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuICdZb3Ugc2FpZDogXCInICsgbXNnICsgJ1wiJztcbn1cblxuZnVuY3Rpb24gZ2V0U2ltaWxhcml0eShsZWZ0OiBzdHJpbmcsIHJpZ2h0OiBzdHJpbmcpIDogbnVtYmVyIHtcbiAgICBpZiAobGVmdCA9PT0gcmlnaHQpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgaWYgKFR5cGVVdGlscy5pc051bGxPclVuZGVmaW5lZChsZWZ0KSB8fFxuICAgICAgICBUeXBlVXRpbHMuaXNOdWxsT3JVbmRlZmluZWQocmlnaHQpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGxlZnQgPSBsZWZ0LnRvTG93ZXJDYXNlKCkudHJpbSgpO1xuICAgIHJpZ2h0ID0gcmlnaHQudG9Mb3dlckNhc2UoKS50cmltKCk7XG4gICAgXG4gICAgdmFyIGRpc3RhbmNlID0gMDtcbiAgICBcbiAgICBpZiAobGVmdCAhPT0gcmlnaHQpIHtcbiAgICAgICAgdmFyIG1hdHJpeCA9IG5ldyBBcnJheShsZWZ0Lmxlbmd0aCArIDEpO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hdHJpeC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbWF0cml4W2ldID0gbmV3IEFycmF5KHJpZ2h0Lmxlbmd0aCArIDEpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgbWF0cml4W2ldLmxlbmd0aDsgaWkrKykge1xuICAgICAgICAgICAgICAgIG1hdHJpeFtpXVtpaV0gPSAwO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbGVmdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbWF0cml4W2ldWzBdID0gaTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPD0gcmlnaHQubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIG1hdHJpeFswXVtqXSA9IGo7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVmdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByaWdodC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgIGlmIChsZWZ0W2ldID09PSByaWdodFtqXSkge1xuICAgICAgICAgICAgICAgICAgICBtYXRyaXhbaSArIDFdW2ogKyAxXSA9IG1hdHJpeFtpXVtqXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdHJpeFtpICsgMV1baiArIDFdID0gTWF0aC5taW4obWF0cml4W2ldW2ogKyAxXSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0cml4W2kgKyAxXVtqXSArIDEpO1xuXG4gICAgICAgICAgICAgICAgICAgIG1hdHJpeFtpICsgMV1baiArIDFdID0gTWF0aC5taW4obWF0cml4W2kgKyAxXVtqICsgMV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0cml4W2ldW2pdICsgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBkaXN0YW5jZSA9IG1hdHJpeFtsZWZ0Lmxlbmd0aF1bcmlnaHQubGVuZ3RoXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gMS4wIC0gZGlzdGFuY2UgLyBNYXRoLm1heChsZWZ0Lmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByaWdodC5sZW5ndGgpOyAgICBcbn1cblxuZnVuY3Rpb24gY2hlY2tGb3JBbGxUZXJtcyhzdHI6IHN0cmluZywgLi4udGVybXM6IHN0cmluZ1tdKSA6IGJvb2xlYW4ge1xuICAgIHZhciBwYXJ0cyA9IHN0ci5zcGxpdChcIiBcIik7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICB2YXIgcCA9IHBhcnRzW2ldO1xuICAgICAgICBpZiAocC50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB2YXIgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCB0ZXJtcy5sZW5ndGg7IGlpKyspIHtcbiAgICAgICAgICAgIHZhciB0ID0gdGVybXNbaWldO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZ2V0U2ltaWxhcml0eShwLCB0KSA+PSAwLjUpIHtcbiAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gZ2V0TGV0dGVyc0FuZERpZ2l0c09ubHkoc3RyOiBzdHJpbmcpIDogc3RyaW5nIHtcbiAgICB2YXIgcmVzdWx0ID0gXCJcIjtcbiAgICBcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoL1thLXpBLVowLTldL2kudGVzdChzdHJbaV0pKSB7XG4gICAgICAgICAgICByZXN1bHQgKz0gc3RyW2ldO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKC9bXFxzXS9pLnRlc3Qoc3RyW2ldKSkge1xuICAgICAgICAgICAgcmVzdWx0ICs9IFwiIFwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGdldFRpbWUoKSA6IHN0cmluZyB7XG4gICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgXG4gICAgdmFyIGhvdXJzID0gbm93LmdldEhvdXJzKCk7XG4gICAgcmV0dXJuIG51bWJlclRvU3RyaW5nKGhvdXJzID09IDEyID8gMTIgOiAoaG91cnMgJSAxMikpICsgXCI6XCIgKyBudW1iZXJUb1N0cmluZyhub3cuZ2V0TWludXRlcygpKSArIFwiIFwiICsgXG4gICAgICAgICAgIChob3VycyA8IDEzID8gXCJBTVwiIDogXCJQTVwiKTtcbn1cblxuZnVuY3Rpb24gbnVtYmVyVG9TdHJpbmcobjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICB2YXIgc3RyID0gXCJcIiArIG47XG4gICAgaWYgKG4gPCAxMCkge1xuICAgICAgICBzdHIgPSBcIjBcIiArIHN0cjtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHN0cjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uTG9hZGVkKGFyZ3M6IEV2ZW50RGF0YSkge1xuICAgIHZhciBwYWdlID0gPFBhZ2U+YXJncy5vYmplY3Q7XG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dCA9IGZyb21PYmplY3Qoe30pO1xuICAgIFxuICAgIHZhciBjaGF0VmlldyA9IG5ldyBDaGF0VmlldygpO1xuICAgIGNoYXRWaWV3LnNlbmRNZXNzYWdlQnV0dG9uQ2FwdGlvbiA9IFwiU2VuZFwiO1xuICAgIGNoYXRWaWV3LnR5cGVNZXNzYWdlSGludCA9IFwiWW91ciBtZXNzYWdlIGZvciBBbGJlcnRcIjtcbiAgICBcbiAgICBjaGF0Vmlldy5ub3RpZnlPblNlbmRNZXNzYWdlVGFwKChldmVudERhdGEpID0+IHtcbiAgICAgICAgZXZlbnREYXRhLm9iamVjdC5hcHBlbmRNZXNzYWdlcyh7ICAgICAgICAgICAgXG4gICAgICAgICAgICBkYXRlOiBnZXRUaW1lKCksXG4gICAgICAgICAgICBpc1JpZ2h0OiB0cnVlLFxuICAgICAgICAgICAgaW1hZ2U6IFwifi9pbWcvbWFyY2VsLmpwZ1wiLFxuICAgICAgICAgICAgbWVzc2FnZTogZXZlbnREYXRhLm1lc3NhZ2UsICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGV2ZW50RGF0YS5yZXNldE1lc3NhZ2UoKTtcbiAgICAgICAgZXZlbnREYXRhLnNjcm9sbFRvQm90dG9tKCk7XG4gICAgICAgIGV2ZW50RGF0YS5mb2N1c1RleHRGaWVsZCgpO1xuICAgICAgICBcbiAgICAgICAgVGltZXIuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgIGV2ZW50RGF0YS5vYmplY3QuYXBwZW5kTWVzc2FnZXMoeyAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgZGF0ZTogZ2V0VGltZSgpLFxuICAgICAgICAgICAgICAgaXNSaWdodDogZmFsc2UsXG4gICAgICAgICAgICAgICBpbWFnZTogXCJ+L2ltZy9hbGVydC5qcGdcIixcbiAgICAgICAgICAgICAgIG1lc3NhZ2U6IGNyZWF0ZUFuc3dlcihldmVudERhdGEubWVzc2FnZSksICAgIFxuICAgICAgICAgICB9KTsgXG4gICAgICAgIH0sIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIwMDApKTtcbiAgICB9KTtcbiAgICBcbiAgICBjaGF0Vmlldy5mb2N1c01lc3NhZ2VGaWVsZCgpO1xuICAgIFxuICAgIHBhZ2UuY29udGVudCA9IGNoYXRWaWV3O1xufSJdfQ==